<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Task Pace Tracker</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#222">

<style>
body { font-family: Arial; margin:0; padding:10px; }
nav { display:flex; gap:10px; margin-bottom:10px; }
button { padding:6px 10px; }
.page { display:none; }
.page.active { display:block; }

.bars {
  display:flex;
  justify-content:center;
  gap:20px;
}

.barWrap { text-align:center; width:90px; }

.container {
  height:200px;
  width:100%;
  border:1px solid #333;
  display:flex;
  align-items:flex-end;
}

.bar { width:100%; background:green; }

.sideNav {
  display:flex;
  justify-content:center;
  gap:6px;
  margin-top:6px;
}

#calendar {
  display:grid;
  grid-template-columns:repeat(7,1fr);
  gap:5px;
  margin-top:10px;
}

.day {
  border:1px solid #aaa;
  min-height:60px;
  padding:4px;
  font-size:12px;
  cursor:pointer;
}

.today { outline:2px solid black; }

/* Popup */
#popup {
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.5);
  align-items:center;
  justify-content:center;
}

#popupBox {
  background:#fff;
  padding:20px;
  border-radius:8px;
  width:80%;
  max-width:300px;
}
</style>
</head>

<body>

<nav>
  <button onclick="showPage('home')">Home</button>
  <button onclick="showPage('month')">Monthly</button>
</nav>

<!-- HOME -->
<div id="home" class="page active">
  <input type="number" id="todayInput" placeholder="Minutes today" oninput="updateToday()">

  <div class="bars">

    <!-- DAY -->
    <div class="barWrap">
      <div class="container"><div id="dayBar" class="bar"></div></div>
      <div id="dayLabel"></div>
    </div>

    <!-- WEEK -->
    <div class="barWrap">
      <div class="container"><div id="weekBar" class="bar"></div></div>
      <div id="weekLabel"></div>
      <div class="sideNav">
        <button onclick="shiftWeek(-1)">◀</button>
        <button onclick="shiftWeek(1)">▶</button>
      </div>
    </div>

    <!-- MONTH -->
    <div class="barWrap">
      <div class="container"><div id="monthBar" class="bar"></div></div>
      <div id="monthLabel"></div>
      <div class="sideNav">
        <button onclick="shiftHomeMonth(-1)">◀</button>
        <button onclick="shiftHomeMonth(1)">▶</button>
      </div>
    </div>

  </div>
</div>

<!-- MONTH TAB -->
<div id="month" class="page">
  <div style="display:flex;justify-content:center;gap:10px;">
    <button onclick="changeMonth(-1)">◀</button>
    <h3 id="monthTitle"></h3>
    <button onclick="changeMonth(1)">▶</button>
  </div>
  <div id="calendar"></div>
</div>

<!-- POPUP -->
<div id="popup">
  <div id="popupBox">
    <h3 id="popupDate"></h3>
    <input type="number" id="popupInput">
    <br><br>
    <button onclick="savePopup()">Save</button>
    <button onclick="closePopup()">Cancel</button>
  </div>
</div>

<script>
/* ---------- GLOBAL ---------- */
const DAILY_TARGET = 600;
let viewedMonth = new Date();
let weekOffset = 0;
let homeMonthOffset = 0;
let selectedDateKey = null;

/* ---------- STORAGE ---------- */
const loadData = () => JSON.parse(localStorage.getItem("taskData")||"{}");
const saveData = d => localStorage.setItem("taskData",JSON.stringify(d));
const todayKey = (d=new Date()) => d.toISOString().slice(0,10);

/* ---------- PAGE ---------- */
function showPage(id){
  document.querySelectorAll(".page").forEach(p=>p.classList.remove("active"));
  const el=document.getElementById(id);
  if(!el) return;
  el.classList.add("active");
  if(id==="month") buildCalendar();
}

/* ---------- HOME ---------- */
function updateToday(){
  const d=loadData();
  d[todayKey()] = Number(todayInput.value)||0;
  saveData(d);
  updateAll();
}

const pace = (a,e)=>e<=0?100:Math.min(a/e*100,100);

function sumWeek(data, ref){
  let sum=0;
  const start=new Date(ref);
  start.setDate(ref.getDate()-ref.getDay());
  for(let i=0;i<7;i++){
    const d=new Date(start);
    d.setDate(start.getDate()+i);
    sum+=data[todayKey(d)]||0;
  }
  return sum;
}

function sumMonth(data, ref){
  let sum=0;
  const y=ref.getFullYear(), m=ref.getMonth();
  const days=new Date(y,m+1,0).getDate();
  for(let i=1;i<=days;i++){
    sum+=data[todayKey(new Date(y,m,i))]||0;
  }
  return sum;
}

function setBar(id,label,pct,name){
  const b=document.getElementById(id);
  b.style.height=pct+"%";
  b.style.background=pct>=80?"green":pct>=50?"yellow":"red";
  document.getElementById(label).innerText=name+": "+pct.toFixed(0)+"%";
}

function updateAll(){
  const data=loadData();
  const now=new Date();

  /* DAY */
  const minutesDay = now.getHours()*60 + now.getMinutes();
  setBar(
    "dayBar","dayLabel",
    pace(data[todayKey()]||0,(DAILY_TARGET/1440)*minutesDay),
    "Day"
  );

  /* WEEK */
  const refWeek = new Date(now);
  refWeek.setDate(refWeek.getDate()+weekOffset*7);
  const actualWeek = sumWeek(data, refWeek);

  let expectedWeek;
  if (weekOffset === 0) {
    const minutesWeek = minutesDay + now.getDay()*1440;
    expectedWeek = (DAILY_TARGET/1440)*minutesWeek;
  } else {
    expectedWeek = DAILY_TARGET * 7;
  }

  setBar("weekBar","weekLabel",pace(actualWeek,expectedWeek),"Week");

  /* MONTH */
  const refMonth = new Date(now);
  refMonth.setMonth(refMonth.getMonth()+homeMonthOffset);
  const actualMonth = sumMonth(data, refMonth);

  let expectedMonth;
  const daysInMonth = new Date(refMonth.getFullYear(),refMonth.getMonth()+1,0).getDate();

  if (homeMonthOffset === 0) {
    const minutesMonth = (now.getDate()-1)*1440 + minutesDay;
    expectedMonth = (DAILY_TARGET/1440)*minutesMonth;
  } else {
    expectedMonth = DAILY_TARGET * daysInMonth;
  }

  setBar("monthBar","monthLabel",pace(actualMonth,expectedMonth),"Month");
}

/* ---------- NAV ---------- */
function shiftWeek(o){ weekOffset+=o; updateAll(); }
function shiftHomeMonth(o){ homeMonthOffset+=o; updateAll(); }

/* ---------- MONTH TAB ---------- */
function buildCalendar(){
  const cal=document.getElementById("calendar");
  cal.innerHTML="";
  const data=loadData();
  const now=new Date(viewedMonth);

  monthTitle.innerText =
    now.toLocaleString("default",{month:"long",year:"numeric"});

  const days=new Date(now.getFullYear(),now.getMonth()+1,0).getDate();
  for(let d=1;d<=days;d++){
    const date=new Date(now.getFullYear(),now.getMonth(),d);
    const key=todayKey(date);
    const div=document.createElement("div");
    div.className="day";
    if(key===todayKey()) div.classList.add("today");
    div.innerHTML=d+"<br>"+(data[key]||0)+"m";
    div.onclick=()=>openPopup(key,data[key]||0);
    cal.appendChild(div);
  }
}

function changeMonth(o){
  viewedMonth.setMonth(viewedMonth.getMonth()+o);
  buildCalendar();
}

/* ---------- POPUP ---------- */
function openPopup(k,m){
  selectedDateKey=k;
  popupDate.innerText=k;
  popupInput.value=m;
  popup.style.display="flex";
}
function closePopup(){ popup.style.display="none"; }
function savePopup(){
  const d=loadData();
  d[selectedDateKey]=Number(popupInput.value)||0;
  saveData(d);
  closePopup();
  updateAll();
  buildCalendar();
}

/* ---------- INIT ---------- */
updateAll();
</script>

<script>
if("serviceWorker" in navigator){
  navigator.serviceWorker.register("service-worker.js");
}
</script>

</body>
</html>
